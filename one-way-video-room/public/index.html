<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>One-Way Dev Room</title>
  <style>
    video { width: 240px; margin: 5px; border: 1px solid black; }
  </style>
</head>
<body>
  <h1>One-Way Dev Room</h1>
  <div id="videos"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const videosDiv = document.getElementById("videos");
    let role = "user";
    let devId = null;
    let localStream;
    const peers = {}; // key = remoteId

    async function startCamera() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true });
      const localVideo = document.createElement("video");
      localVideo.autoplay = true;
      localVideo.muted = true; // prevent echo
      localVideo.srcObject = localStream;
      videosDiv.appendChild(localVideo);
    }

    // Assign role
    socket.on("role", (r) => {
      role = r;
      startCamera();
    });

    // Users learn dev ID
    socket.on("dev-id", (id) => {
      devId = id;
      connectToDev();
    });

    // DEV: notified of new users
    socket.on("new-user", (userId) => {
      console.log("New user connected:", userId);
    });

    // DEV: notified of user disconnect
    socket.on("user-disconnected", (userId) => {
      console.log("User disconnected:", userId);
      if (peers[userId]) {
        peers[userId].close();
        delete peers[userId];
      }
      // Remove their video
      const videos = Array.from(videosDiv.getElementsByTagName("video"));
      videos.forEach(video => {
        if (video.dataset.id === userId) video.remove();
      });
    });

    // Users connect to dev
    async function connectToDev() {
      if (role !== "user" || !devId) return;

      const pc = new RTCPeerConnection();
      peers[devId] = pc;

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("ice-candidate", { candidate: event.candidate, to: devId });
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      socket.emit("offer", { sdp: offer });
    }

    // DEV receives offers from users
    socket.on("offer", async (data) => {
      if (role !== "dev") return;

      const pc = new RTCPeerConnection();
      peers[data.from] = pc;

      pc.ontrack = (event) => {
        const remoteVideo = document.createElement("video");
        remoteVideo.autoplay = true;
        remoteVideo.srcObject = event.streams[0];
        remoteVideo.dataset.id = data.from; // tag video with user id
        videosDiv.appendChild(remoteVideo);
      };

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("ice-candidate", { candidate: event.candidate, to: data.from });
        }
      };

      await pc.setRemoteDescription(data.sdp);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      socket.emit("answer", { sdp: answer, to: data.from });
    });

    // Both dev and users receive answers
    socket.on("answer", async (data) => {
      const pc = peers[data.from];
      if (pc) await pc.setRemoteDescription(data.sdp);
    });

    // Both dev and users receive ICE candidates
    socket.on("ice-candidate", async (data) => {
      const pc = peers[data.from];
      if (pc) await pc.addIceCandidate(data.candidate);
    });
  </script>
</body>
</html>
